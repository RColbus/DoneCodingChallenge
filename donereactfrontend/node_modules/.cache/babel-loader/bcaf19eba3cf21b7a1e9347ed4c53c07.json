{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.handleClientScriptLoad = handleClientScriptLoad;\nexports.initScriptLoader = initScriptLoader;\nexports.default = void 0;\n\nvar _extends = require(\"@swc/helpers/lib/_extends.js\").default;\n\nvar _interop_require_wildcard = require(\"@swc/helpers/lib/_interop_require_wildcard.js\").default;\n\nvar _object_without_properties_loose = require(\"@swc/helpers/lib/_object_without_properties_loose.js\").default;\n\nvar _react = _interop_require_wildcard(require(\"react\"));\n\nvar _headManagerContext = require(\"../shared/lib/head-manager-context\");\n\nvar _headManager = require(\"./head-manager\");\n\nvar _requestIdleCallback = require(\"./request-idle-callback\");\n\nconst ScriptCache = new Map();\nconst LoadCache = new Set();\nconst ignoreProps = ['onLoad', 'onReady', 'dangerouslySetInnerHTML', 'children', 'onError', 'strategy'];\n\nconst loadScript = props => {\n  const {\n    src,\n    id,\n    onLoad = () => {},\n    onReady = null,\n    dangerouslySetInnerHTML,\n    children = '',\n    strategy = 'afterInteractive',\n    onError\n  } = props;\n  const cacheKey = id || src; // Script has already loaded\n\n  if (cacheKey && LoadCache.has(cacheKey)) {\n    return;\n  } // Contents of this script are already loading/loaded\n\n\n  if (ScriptCache.has(src)) {\n    LoadCache.add(cacheKey); // Execute onLoad since the script loading has begun\n\n    ScriptCache.get(src).then(onLoad, onError);\n    return;\n  }\n  /** Execute after the script first loaded */\n\n\n  const afterLoad = () => {\n    // Run onReady for the first time after load event\n    if (onReady) {\n      onReady();\n    } // add cacheKey to LoadCache when load successfully\n\n\n    LoadCache.add(cacheKey);\n  };\n\n  const el = document.createElement('script');\n  const loadPromise = new Promise((resolve, reject) => {\n    el.addEventListener('load', function (e) {\n      resolve();\n\n      if (onLoad) {\n        onLoad.call(this, e);\n      }\n\n      afterLoad();\n    });\n    el.addEventListener('error', function (e) {\n      reject(e);\n    });\n  }).catch(function (e) {\n    if (onError) {\n      onError(e);\n    }\n  });\n\n  if (dangerouslySetInnerHTML) {\n    el.innerHTML = dangerouslySetInnerHTML.__html || '';\n    afterLoad();\n  } else if (children) {\n    el.textContent = typeof children === 'string' ? children : Array.isArray(children) ? children.join('') : '';\n    afterLoad();\n  } else if (src) {\n    el.src = src; // do not add cacheKey into LoadCache for remote script here\n    // cacheKey will be added to LoadCache when it is actually loaded (see loadPromise above)\n\n    ScriptCache.set(src, loadPromise);\n  }\n\n  for (const [k, value] of Object.entries(props)) {\n    if (value === undefined || ignoreProps.includes(k)) {\n      continue;\n    }\n\n    const attr = _headManager.DOMAttributeNames[k] || k.toLowerCase();\n    el.setAttribute(attr, value);\n  }\n\n  if (strategy === 'worker') {\n    el.setAttribute('type', 'text/partytown');\n  }\n\n  el.setAttribute('data-nscript', strategy);\n  document.body.appendChild(el);\n};\n\nfunction handleClientScriptLoad(props) {\n  const {\n    strategy = 'afterInteractive'\n  } = props;\n\n  if (strategy === 'lazyOnload') {\n    window.addEventListener('load', () => {\n      (0, _requestIdleCallback).requestIdleCallback(() => loadScript(props));\n    });\n  } else {\n    loadScript(props);\n  }\n}\n\nfunction loadLazyScript(props) {\n  if (document.readyState === 'complete') {\n    (0, _requestIdleCallback).requestIdleCallback(() => loadScript(props));\n  } else {\n    window.addEventListener('load', () => {\n      (0, _requestIdleCallback).requestIdleCallback(() => loadScript(props));\n    });\n  }\n}\n\nfunction addBeforeInteractiveToCache() {\n  const scripts = [...document.querySelectorAll('[data-nscript=\"beforeInteractive\"]'), ...document.querySelectorAll('[data-nscript=\"beforePageRender\"]')];\n  scripts.forEach(script => {\n    const cacheKey = script.id || script.getAttribute('src');\n    LoadCache.add(cacheKey);\n  });\n}\n\nfunction initScriptLoader(scriptLoaderItems) {\n  scriptLoaderItems.forEach(handleClientScriptLoad);\n  addBeforeInteractiveToCache();\n}\n\nfunction Script(props) {\n  const {\n    id,\n    src = '',\n    onLoad = () => {},\n    onReady = null,\n    strategy = 'afterInteractive',\n    onError\n  } = props,\n        restProps = _object_without_properties_loose(props, [\"id\", \"src\", \"onLoad\", \"onReady\", \"strategy\", \"onError\"]); // Context is available only during SSR\n\n\n  const {\n    updateScripts,\n    scripts,\n    getIsSsr\n  } = (0, _react).useContext(_headManagerContext.HeadManagerContext);\n  /**\n  * - First mount:\n  *   1. The useEffect for onReady executes\n  *   2. hasOnReadyEffectCalled.current is false, but the script hasn't loaded yet (not in LoadCache)\n  *      onReady is skipped, set hasOnReadyEffectCalled.current to true\n  *   3. The useEffect for loadScript executes\n  *      Once the script is loaded, the onReady will be called by then\n  *   [If strict mode is enabled / is wrapped in <OffScreen /> component]\n  *   5. The useEffect for onReady executes again\n  *   6. hasOnReadyEffectCalled.current is true, so entire effect is skipped\n  *   7. The useEffect for loadScript executes again\n  *   8. The script is already loaded/loading, loadScript bails out\n  *\n  * - Second mount:\n  *   1. The useEffect for onReady executes\n  *   2. hasOnReadyEffectCalled.current is false, but the script has already loaded (found in LoadCache)\n  *      onReady is called, set hasOnReadyEffectCalled.current to true\n  *   3. The useEffect for loadScript executes\n  *   4. The script is already loaded, loadScript bails out\n  *   [If strict mode is enabled / is wrapped in <OffScreen /> component]\n  *   5. The useEffect for onReady executes again\n  *   6. hasOnReadyEffectCalled.current is true, so entire effect is skipped\n  *   7. The useEffect for loadScript executes again\n  *   8. The script is already loaded, loadScript will bail out\n  */\n\n  const hasOnReadyEffectCalled = (0, _react).useRef(false);\n  (0, _react).useEffect(() => {\n    const cacheKey = id || src;\n\n    if (!hasOnReadyEffectCalled.current) {\n      // Run onReady if script has loaded before but component is re-mounted\n      if (onReady && cacheKey && LoadCache.has(cacheKey)) {\n        onReady();\n      }\n\n      hasOnReadyEffectCalled.current = true;\n    }\n  }, [onReady, id, src]);\n  (0, _react).useEffect(() => {\n    if (strategy === 'afterInteractive') {\n      loadScript(props);\n    } else if (strategy === 'lazyOnload') {\n      loadLazyScript(props);\n    }\n  }, [props, strategy]);\n\n  if (strategy === 'beforeInteractive' || strategy === 'worker') {\n    if (updateScripts) {\n      scripts[strategy] = (scripts[strategy] || []).concat([_extends({\n        id,\n        src,\n        onLoad,\n        onReady,\n        onError\n      }, restProps)]);\n      updateScripts(scripts);\n    } else if (getIsSsr && getIsSsr()) {\n      // Script has already loaded during SSR\n      LoadCache.add(id || src);\n    } else if (getIsSsr && !getIsSsr()) {\n      loadScript(props);\n    }\n  }\n\n  return null;\n}\n\nObject.defineProperty(Script, '__nextScript', {\n  value: true\n});\nvar _default = Script;\nexports.default = _default;\n\nif ((typeof exports.default === 'function' || typeof exports.default === 'object' && exports.default !== null) && typeof exports.default.__esModule === 'undefined') {\n  Object.defineProperty(exports.default, '__esModule', {\n    value: true\n  });\n  Object.assign(exports.default, exports);\n  module.exports = exports.default;\n}","map":{"version":3,"mappings":"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","names":["handleClientScriptLoad","initScriptLoader","ScriptCache","Map","LoadCache","Set","ignoreProps","loadScript","props","src","id","onLoad","onReady","dangerouslySetInnerHTML","children","strategy","onError","cacheKey","has","add","get","then","afterLoad","el","document","createElement","loadPromise","Promise","resolve","reject","addEventListener","e","call","catch","innerHTML","__html","textContent","Array","isArray","join","set","k","value","Object","entries","undefined","includes","attr","DOMAttributeNames","toLowerCase","setAttribute","body","appendChild","window","requestIdleCallback","loadLazyScript","readyState","addBeforeInteractiveToCache","scripts","querySelectorAll","forEach","script","getAttribute","scriptLoaderItems","Script","restProps","updateScripts","getIsSsr","useContext","HeadManagerContext","hasOnReadyEffectCalled","useRef","useEffect","current","concat","_extends","defineProperty"],"sources":["../../client/script.tsx"],"sourcesContent":[null]},"metadata":{},"sourceType":"script"}